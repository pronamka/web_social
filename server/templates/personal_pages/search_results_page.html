{% extends 'personal_pages/base.html' %}
{% block title %}Results for {{search_query}}{% endblock %}
{% block content %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/fontawesome-free-6.2.0-web/css/all.min.css')}}">
<meta name="viewport" content="width=device-width">
<main role="main">
    <dialog id="add_to_search"></dialog>
    <article>
        <p id="searched_for"></p>
        <div id="search_results"></div>
        <button onclick="search_new()" id="more_posts_btn">More results</button>
    </article>
</main>
<script>
    const settings = {'search_query': '{{search_query}}', 
    'results_required': 5, 'results_received': 0, 
    'search_strictly': '{{search_strictly}}'}
    document.addEventListener('DOMContentLoaded', search_new())

    function sendRequest(method, url, body) {
        const headers = {'Content-Type': 'application/json'}
        return fetch(url, {
            method: method,
            body: JSON.stringify(body),
            headers: headers}).then(response => {
            return response.text()
        })
    }

    function search_strictly(query){
        var dialog = document.getElementById('add_to_search')
        var html = `<p>We autocorrected your query, because we 
            do not have words you used in our dictionary. If you spelled
            the word right, and would like to add it to the dictionary, 
            please, click the button below.</p>
                <button onclick="window.location.replace('/search_page?query=${query}&search_strictly=1&add_to_search=1')">Add to our dictionary and search</button>
                 <button onclick="window.location.replace('/search_page?query=${query}&search_strictly=1')">Search without adding</button>`
        dialog.innerHTML = html
        dialog.showModal()
    }
    
    function search_new(){
        sendRequest('POST', '/search/', settings).then(resp=>{
            var posts=JSON.parse(resp)
            console.log(posts['searched_for'])
            if ((posts['search_results'].length == 0) && (posts['searched_for'] == settings['search_query'])) {
                addPost('<h2>No results</h2>')
                document.getElementById('more_posts_btn').remove()
                return false
            }
            if (posts['search_results'].length == 0){
                addPost('<h2>No results</h2>')
                document.getElementById('more_posts_btn').remove()
            }
            console.log(settings['results_received'] == 0)
            if ((posts['searched_for'] != settings['search_query']) | 
            (settings['results_received'] == 0) ) {
                console.log('in')
                document.getElementById('searched_for').innerHTML = 
                `Showing results for ${posts['searched_for']}. 
                <a onclick="sendRequest(search_strictly('${settings['search_query']}'))">
                    Search ${settings['search_query']}</a>`
            }
            settings['results_received'] += posts['search_results'].length
            buildPosts(posts['search_results'])})
        }
        
    function buildPosts(post_dict){
        for (var i=0, l=Object.keys(post_dict).length-1; i<=l; i++){
            try{
                title = post_dict[i]['title'];
                author = post_dict[i]['author'];
                post_id = post_dict[i]['post_id'];
                creation_date = post_dict[i]['display_date']
                path = '/static/upload_folder/'+title;
                post = buildHTML(path, author, title, post_id, creation_date);
                addPost(post);
            }
            catch(error){
                if (error != "TypeError: Cannot read properties of undefined (reading 'comment_registry')"){
                    console.log('An error has occured:'+error)
                }
                else {
                    comments = 'No comments yet.'
                }
            }
        }
    }

    function buildHTML(path, author, title, post_id, creation_date){
        html = `<div class="table_cell" id="`+post_id+`">
                    <iframe width="900" height="1075" src="`+ path+`"></iframe>
                    <details class="post_data" open>
                        <summary>`+title+`</summary>
                        <ul>
                            <li>`+author+`</li>
                            <li>`+post_id+`</li>
                            <li>`+creation_date+`</li>
                        </ul>
                    </details>
                </div>`;
        return html
    }

    function addPost(html) {
        const tab = document.getElementById('search_results');
        var template = document.createElement('template');
        html = html.trim(); // Never return a text node of whitespace as the result
        template.innerHTML = html;
        tab.appendChild(template.content);
        return template.content.firstChild;
    }
</script>
{% endblock %}
